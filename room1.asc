// room script file

function room_Load()
{
  //Escalado de personajes
 cNanny.Scaling = 170;
 cSatsuki.Scaling = 150;
 cMei.Scaling = 140;
  
 //Escalado de objetos
 oPalo.Scaling = 140;
}

function hCambiarRoom_WalkOn(Hotspot *theHotspot)
{
  if(ultimaRoom == 2 && puzleRoom1Completado){ //Pasas por el hotpot y has completado el puzle de la room 1,  te vas a la room 3
    
    ultimaRoom = player.Room;
    player.ChangeRoom(3);
    cMei.ChangeRoom(3);
    
  }else if(ultimaRoom == -1){// Si la ultima room es la -1, pasas al jardin
    
    ultimaRoom = player.Room;
    player.ChangeRoom(2, 23, 351, eDirectionRight);
  
  }
}

function room_AfterFadeIn()
{
  // Condicionante para ejecutar por separado las entradas a la room 1
  if(ultimaRoom == 2 && puzleRoom2Completado){// Si vienes de la room 2 y has completado el puzle
    
    // Vuelta a la room 1
    StartCutscene(eSkipESCOnly);
    
    // Poner franjas
    oFranjaSuperiorRoom1.Move(0, 40, 1, eNoBlock, eAnywhere);
    oFranjaInferiorRoom1.Move(0, 440, 1, eNoBlock, eAnywhere);
    
    // Se ejecuta el dialogo de la vuelta a la room 1
    dialogoVueltaRoom1();
    
    //FadeOut
    FadeOut(5);
    
    //Los personajes se cambian de posicion
    cMei.ChangeView(3);
    cSatsuki.ChangeView(1);
    
    cNanny.Move(118, 314, eNoBlock, eAnywhere);
    cSatsuki.Walk(522, 337, eNoBlock, eWalkableAreas);
    cMei.Move(592, 344, eBlock, eWalkableAreas);
    cMei.FaceDirection(eDirectionRight);
    
    //FadeIn acaba
    FadeIn(10);
    Wait(120);
    
    //Dialogo final de la room 1
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("Oh, sigue lloviendo. Mei, deberíamos coger el paraguas de papá e ir a buscarlo a la estación. Sino se va a mojar.");
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Vale. ¿Dónde lo dejaste ,Satsuki?");
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("Está guardado en el armario, dejé la llave encima de la mesa.");
    
    // Anda hacia la mesa
    cSatsuki.Walk(272, 364, eBlock, eWalkableAreas);
    
    Wait(15);
    cSatsuki.FaceDirection(eDirectionRight);
    Wait(35);
    cSatsuki.FaceDirection(eDirectionLeft);
    
    mostrarDialogo("¿¡Eh?! No está aquí. ¿Dónde podrá haber ido a parar…?");
    
    cMei.Walk(563, 388, eBlock, eWalkableAreas);
    cMei.ChangeView(10);
    
    oPolvoSuelo.Visible = true;
    
    // Se quitan las franjas
    oFranjaSuperiorRoom1.Move(0, 0, 1, eNoBlock, eAnywhere);
    oFranjaInferiorRoom1.Move(0, 475, 1, eNoBlock, eAnywhere);
    
    //Aparecen los bichos de polvo con la llave entre ellos
    oBichoDePolvo2.Move(11, 72, 2, eNoBlock, eAnywhere);
    oLlave.Move(0, 71, 1, eNoBlock, eAnywhere);
    oBichosDePolvo.Move(1, 91, 1, eNoBlock, eAnywhere);
    oBichodePolvo3.Move(-5, 50, 1, eNoBlock, eAnywhere);
    
        EndCutscene();
  
    //Aqui va la programacion del puzle del paraguas
    if (player.ActiveInventory == (iHebras) && player.ActiveInventory == (iCuerda) && player.ActiveInventory == (iPalo)){
      
      imgDialogo.BackgroundGraphic = 148;
      mostrarDialogo("Con todo esto creo que podré hacer una escoba para limpiar ese polvo de la cocina.");
      
    }
    
  }else if(ultimaRoom == -1){ //Si vienes de la room -1 se activa la cinemaica inicial
  
    StartCutscene(eSkipESCOnly); // Esto es para saltar toda la cinematica con el Esc,  cuando acabemos el juego lo eliminamos
    
    // Se ponen las franjas
    oFranjaSuperiorRoom1.Move(0, 40, 1, eNoBlock, eAnywhere);
    oFranjaInferiorRoom1.Move(0, 440, 1, eNoBlock, eAnywhere);
    Wait(80);
    
    //Se acercan las dos niñas
    cSatsuki.Walk(20, 355, eNoBlock, eAnywhere);
    cMei.Walk(13, 309, eBlock, eAnywhere);
    
    cMei.FaceDirection(eDirectionRight);
    cSatsuki.FaceDirection(eDirectionRight);
    
    imgDialogo.BackgroundGraphic = 148; // Satsuki
    mostrarDialogo("¡Nanny! ¡Nos hemos encontrado con unos bichitos negros en el desvan! ¿Nos cuentas algo sobre los animalitos magicos que viven en esta casa?");

    imgDialogo.BackgroundGraphic = 149; // Nanny
    mostrarDialogo("Claro niñas. Sentaos aquí a mi lado. Según dicen las leyendas, en las casas abandonadas viven los conejos de polvo porque les gustan los sitios tristes. Sin embargo, ahora que os habéis mudado aquí, están saliendo porque sois unas niñas muy felices.");
    
    // Se sientan las niñas
    cSatsuki.ChangeView(6);
    cMei.Walk(100, 330, eBlock, eWalkableAreas);
    cMei.ChangeView(11);
    Wait(30);
    
    // Comienza el dialogo
    dialogoRoom1();
    
    // Se quitan las franjas
    oFranjaSuperiorRoom1.Move(0, 0, 1, eNoBlock, eAnywhere);
    oFranjaInferiorRoom1.Move(0, 475, 1, eNoBlock, eAnywhere);
    
    // NavMesh, Satsuki se sale de la escena
    cSatsuki.Walk(30, 304, eBlock, eWalkableAreas);
    cSatsuki.Walk(246, 304, eBlock, eWalkableAreas);
    cSatsuki.Walk(623, 327, eBlock, eWalkableAreas);
    
    EndCutscene();
  }
}

//SI miras al polvo del suelo dice esto
function oPolvoSuelo_Look(Object *theObject, CursorMode mode)
{
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("¿Eh? ¿Y todo este polvo? Parece que va hacia la cocina…");
}

//Si interactuas con el polvo del suelo
function oPolvoSuelo_Interact(Object *theObject, CursorMode mode)
{
  
  cSatsuki.Walk(oPolvoSuelo.X, oPolvoSuelo.Y, eBlock, eWalkableAreas);
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("Creo que he pisado polvo...");
  oPolvoSuelo.Visible = false;
}

//AL interactuar con el palo pasa esto
function oPalo_Interact(Object *theObject, CursorMode mode)
{
  cSatsuki.Walk(0, 266, eBlock, eWalkableAreas);
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("¡Bien! Creo que se me ha ocurrido una idea de qué hacer con esto…");
  cSatsuki.AddInventory(iPalo);
  oPalo.Visible = false;
}

//AL mirar el palo
function oPalo_Look(Object *theObject, CursorMode mode)
{
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("Un palo largo. Igual me resulta útil.");
}

//Si interactuas con las hebras, andas hacia ellas y las coges
function oHebrasGrupo_Interact(Object *theObject, CursorMode mode)
{
  
  cSatsuki.Walk(537, 321, eBlock, eWalkableAreas);
  oHebrasGrupo.Visible = false;
  
  cSatsuki.Walk(550, 324, eBlock, eWalkableAreas);
  oHebraIndividual.Visible = false;
  
  cSatsuki.Walk(561, 325, eBlock, eWalkableAreas);
  oHebrasGrupo2.Visible = false;
  
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("¡Bien! ¡Lo que ha costado!");
  cSatsuki.AddInventory(iHebras);
  
}

// Si miras las hebras
function oHebrasGrupo_Look(Object *theObject, CursorMode mode)
{
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("El viento ha metido todas estas hierbas en casa. Debería recogerlas.");
    
}

//Si tienes la llave en el inventario te deja abrir el armario
function hArmario_Interact(Hotspot *theHotspot, CursorMode mode)
{
  //Debug,  cuandointeractuas con el armario te manda directamente a la room 3
      cSatsuki.AddInventory(iParaguas);
      puzleRoom1Completado = true; //Detector
      ultimaRoom = player.Room;
      player.ChangeRoom(3, -60, 350);
      cMei.ChangeRoom(3, -60, 350);
  
  //Puzle de la room 1
  
  if(cSatsuki.ActiveInventory == iLlave){
    
    //Si tienes la llave
    FadeOut(3);
    
    //Sonido de armario abriendose
    sAbrirPuertaArmario.Play();
    Wait(20);
    sCerrarPuertaArmario.Play();
    
    puzleRoom1Completado = true; //Detector
    
    cSatsuki.ChangeView(9);
    cMei.ChangeView(12);
    FadeIn(3);
  
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Por fin tengo el paraguas.");
    
    cSatsuki.ChangeView(9);
    cMei.ChangeView(12);
  
    cSatsuki.Walk(610, 323, eNoBlock, eWalkableAreas);
    
    mostrarDialogo("Mei, vamos. Papá ya estará a punto de llegar.");
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("¡Voy!");
    
    cSatsuki.Walk(610, 323, eBlock, eWalkableAreas);
    
  }else{
    
    //Meter sonido de puerta que no se abre
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Esta cerrado, necesito la llave");
  }
  
}

//Si interactuas con el monton de polvo hace esto
function oBichosDePolvo_Interact(Object *theObject, CursorMode mode)
{
  if( player.ActiveInventory != iEscoba ){
      
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("Tal vez debería no tocar esta esquina sin limpiarla antes, me voy a manchar.");
  }
}

//Si interactuas con el monton de polvo hace esto
function oBichoDePolvo2_Interact(Object *theObject, CursorMode mode)
{
  if( player.ActiveInventory != iEscoba ){
      
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("Tal vez debería no tocar esta esquina sin limpiarla antes, me voy a manchar.");
  }
}

//Si interactuas con el monton de polvo hace esto
function oBichodePolvo3_Interact(Object *theObject, CursorMode mode)
{
  if( player.ActiveInventory != iEscoba ){
      
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("Tal vez debería no tocar esta esquina sin limpiarla antes, me voy a manchar.");
  }
}

//Si miras al monton de polvo hace esto
function oBichosDePolvo_Look(Object *theObject, CursorMode mode)
{
  if( player.ActiveInventory != iEscoba ){
    
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("Vaya, sí que se ha acumulado polvo allí. ¿Hmm? Juraría ver algo brillante entre el polvo. Ojalá tuviera algo para limpiarlo.");
  }
}

//Si miras al monton de polvo hace esto
function oBichoDePolvo2_Look(Object *theObject, CursorMode mode)
{
  if( player.ActiveInventory != iEscoba ){
    
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("Vaya, sí que se ha acumulado polvo allí. ¿Hmm? Juraría ver algo brillante entre el polvo. Ojalá tuviera algo para limpiarlo.");
  }
}

//Si miras al monton de polvo hace esto
function oBichodePolvo3_Look(Object *theObject, CursorMode mode)
{
  if( player.ActiveInventory != iEscoba ){
    
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("Vaya, sí que se ha acumulado polvo allí. ¿Hmm? Juraría ver algo brillante entre el polvo. Ojalá tuviera algo para limpiarlo.");
  }
}



function oHebraIndividual_Interact(Object *theObject, CursorMode mode)
{
    cSatsuki.Walk(537, 321, eBlock, eWalkableAreas);
  oHebrasGrupo.Visible = false;
  
  cSatsuki.Walk(550, 324, eBlock, eWalkableAreas);
  oHebraIndividual.Visible = false;
  
  cSatsuki.Walk(561, 325, eBlock, eWalkableAreas);
  oHebrasGrupo2.Visible = false;
  
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("¡Bien! ¡Lo que ha costado!");
  cSatsuki.AddInventory(iHebras);
}

function oHebrasGrupo2_Interact(Object *theObject, CursorMode mode)
{
    cSatsuki.Walk(537, 321, eBlock, eWalkableAreas);
  oHebrasGrupo.Visible = false;
  
  cSatsuki.Walk(550, 324, eBlock, eWalkableAreas);
  oHebraIndividual.Visible = false;
  
  cSatsuki.Walk(561, 325, eBlock, eWalkableAreas);
  oHebrasGrupo2.Visible = false;
  
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("¡Bien! ¡Lo que ha costado!");
  cSatsuki.AddInventory(iHebras);
}

function oHebraIndividual_Look(Object *theObject, CursorMode mode)
{
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("El viento ha metido todas estas hierbas en casa. Debería recogerlas.");
}

function oHebrasGrupo2_Look(Object *theObject, CursorMode mode)
{
  imgDialogo.BackgroundGraphic = 148;
  mostrarDialogo("El viento ha metido todas estas hierbas en casa. Debería recogerlas.");
}

function oBichosDePolvo_UseInv(Object *theObject, CursorMode mode)
{
  if(player.ActiveInventory == iEscoba ){

    oBichosDePolvo.Visible = false;
    oBichoDePolvo2.Visible = false;
    oBichodePolvo3.Visible = false;

    if (oBichosDePolvo.Visible == false && oBichoDePolvo2.Visible == false && oBichodePolvo3.Visible == false){
    
    oLlave.Move(9, 308,  3,  eBlock,  eAnywhere);
    gLlaveDown = 1;
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("¡Bien! Ahora podre abrir el armario con esta llave. (Dialogo provisional)");
    } 
  }
}

function oBichoDePolvo2_UseInv(Object *theObject, CursorMode mode)
{
  if( player.ActiveInventory == iEscoba ){

    oBichosDePolvo.Visible = false;
    oBichoDePolvo2.Visible = false;
    oBichodePolvo3.Visible = false;
  
    if (oBichosDePolvo.Visible == false && oBichoDePolvo2.Visible == false && oBichodePolvo3.Visible == false){
    
    oLlave.Move(9, 308,  3,  eBlock,  eAnywhere);
    gLlaveDown = 1;

    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("¡Bien! Ahora podre abrir el armario con esta llave. (Dialogo provisional)");
    } 
  }
}

function oBichodePolvo3_UseInv(Object *theObject, CursorMode mode)
{
  if( player.ActiveInventory == iEscoba ){

    oBichosDePolvo.Visible = false;
    oBichoDePolvo2.Visible = false;
    oBichodePolvo3.Visible = false;
  
    if (oBichosDePolvo.Visible == false && oBichoDePolvo2.Visible == false && oBichodePolvo3.Visible == false){
    
    oLlave.Move(9, 308,  3,  eBlock,  eAnywhere);
    gLlaveDown = 1;
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("¡Bien! Ahora podre abrir el armario con esta llave. (Dialogo provisional)");
    } 
  }
}

function oLlave_Interact(Object *theObject, CursorMode mode)
{
  if (gLlaveDown == 1){
      cSatsuki.Walk(oLlave.X,  oLlave.Y,  eBlock);
      cSatsuki.FaceObject(oLlave);
      cSatsuki.AddInventory(iLlave);
      oLlave.Visible = false;
    }
}
