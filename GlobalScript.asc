// main global script file

// called when the game starts, before the first room is loaded
function game_start()
{
  // Auto-save on the save slot 999
  SetRestartPoint();
}

// called on every game cycle, except when the game is blocked
function repeatedly_execute()
{
  
}

// called on every game cycle, even when the game is blocked
function repeatedly_execute_always()
{
}

// called when a key is pressed
function on_key_press(eKeyCode keycode, int mod)
{
  if (IsGamePaused())
  {
    // game paused, so don't react to any keypresses
    keycode = 0;
  }
  else if (keycode == eKeyQ && (mod & eKeyModCtrl))
  {
    // Ctrl-Q will quit the game
    QuitGame(1);
  }
  else if (keycode == eKeyF9)
  {
    // F9 will restart the game
    RestartGame();
  }
  else if (keycode == eKeyF12)
  {
    // F12 will save a screenshot to the save game folder
    SaveScreenShot("screenshot.pcx");
  }
  else if (mod & eKeyModCtrl)
  {
    if (keycode == eKeyS)
    {
      // Ctrl-S will give the player all defined inventory items
      Debug(0, 0);
    }
    else if (keycode == eKeyV)
    {
      // Ctrl-V will show game engine version and build date
      Debug(1, 0);
    }
    else if (keycode == eKeyA)
    {
      // Ctrl-A will show walkable areas
      Debug(2, 3);
    }
    else if (keycode == eKeyX)
    {
      // Ctrl-X will let the player teleport to any room
      Debug(3, 0);
    }

  }
}

// called when a mouse button is clicked
function on_mouse_click(MouseButton button)
{
  if (IsGamePaused())
  {
    // game is paused, so do nothing (i.e. don't process mouse clicks)
  }
  else if (button == eMouseLeft)
  {
    // left-click, so try using the current mouse cursor mode at this position
    Room.ProcessClick(mouse.x, mouse.y, mouse.Mode);
  }
  else if (button == eMouseRight)
  {
    // right-click, so cycle the mouse cursor mode
    mouse.SelectNextMode();
  }
}

function dialog_request(int param)
{

}

// Este código hace invisible la GUI de inventario,  he puesto un botón tanto como en gInv como en gMochila. Esto abre y cierra la gui.
function bMochila_OnClick(GUIControl *control, MouseButton button)
{
  if (gInv.Visible == false)
  {
    gInv.Visible = true;
    gMochila.Visible = false;
    }else{
    gInv.Visible = false; 
    gMochila.Visible = true;    
  }
}

function Exit_OnClick(GUIControl *control, MouseButton button)
{
  gInv.Visible = false;
  gMochila.Visible = true;
}

function cMei_Talk(Character *theCharacter, CursorMode mode)
{
  // Perteneciente a la room 1
  if(ultimaRoom == 2 && gTengoCuerda == 0){ // Si vienes del jardin y no tienes la cuerda
    
    dialogoMeiSinCuerda();
    
  }else if(ultimaRoom == 2 && gTengoCuerda == 1 ){ //Si vienes del jardin y tienes la cuerda
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("Satsuki, ¿me puedes devolver ya mi cuerda? Me aburro…");
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Lo siento Mei, todavía me hace falta.");
    
  }else if(ultimaRoom == 1 && puzleRoom1Completado){ // Si vienes del salon y has completado el puzle de la escoba
  
    cSatsuki.Walk(204, 325, eBlock, eWalkableAreas);
    cSatsuki.FaceDirection(eDirectionLeft);
    
    cMei.FaceDirection(eDirectionRight);
    
    if (gBusHaPasado != 1){
    // Primer tramo de dialogo room 3
    dialogo2Room3();
    
    //Pasa el primer bus y se baja el extraño
    cBus.Move(100, 360, eBlock, eAnywhere);
    
    cHombreRaro.Move(100, 340, eBlock, eAnywhere);
    cSatsuki.FaceDirection(eDirectionDownRight);
    
    cBus.Move(920, 360, eNoBlock, eAnywhere);
    Wait(140);
    cHombreRaro.Walk(-100, 340, eNoBlock, eAnywhere);
    
    //Siguiente dialogo
    dialogo3Room3();
    Wait(120);
    cSatsuki.FaceDirection(eDirectionLeft);
    
    //Aparece totoro
    cSatsuki.FaceDirection(eDirectionDown);
    cMei.FaceDirection(eDirectionDown);
    
    ShakeScreen(1);
    Wait(250);
    ShakeScreen(1);
    
    cTotoro.Walk(270, 320, eBlock, eAnywhere);
    cTotoro.FaceDirection(eDirectionDown);
    
    imgDialogo.BackgroundGraphic = 148; // Satsuki
    mostrarDialogo("¡Ahhh! Que susto…");
    
    cMei.FaceDirection(eDirectionRight);
    imgDialogo.BackgroundGraphic = 150; // Mei
    mostrarDialogo("¡Totoro! ¿Eres tú de verdad?");
    
    mostrarDialogo("¿Totoro? ¿Te pasa algo? Estás temblando.");
    mostrarDialogo("Quizás… ¿tiene frío? Voy a darle el paraguas...");
    
    //Interactuas dandole el paraguas al totoro
    
    imgDialogo.BackgroundGraphic = 265; // totoro
    mostrarDialogo("Grrr....");
    
    Wait(60);
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("Satsuki ¿Tal vez quiere una de esas hojas?");
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Puede ser… A lo mejor podemos mirar por los alrededores para ver si podemos hacer caer una de ellas y dársela.");
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("¡Sí! Vamos a mirar alrededor.");
    
    dialogoConTotoroCompletado = true;
    //Si has completado el dialogo pero aun no tienes la hoja
  if(dialogoConTotoroCompletado && gHojaDown == 0){
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("Satsuki, hay que hacer algo para conseguir esa hoja grande.");
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Sigamos buscando juntas una manera de conseguirla.");
  }
  
  if(dialogoConTotoroCompletado && gHojaDown == 1 ){
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("¿Se te ocurre qué más podemos darle a Totoro?");
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("Recuerdo que la abuela dijo que a los Totoros les gustaba robar las bellotas. A lo mejor podemos buscar algo por aquí para envolverlas e intentar dárselas.");
  }
    }
  }
  
  

}

//Si interactuas con los totoros pasa esto
function ctotoroBlanco_Interact(Character *theCharacter, CursorMode mode)
{
  imgDialogo.BackgroundGraphic = 150;
  mostrarDialogo("Vaya… que bonitos y pequeñitos son. Se ven tal como la abuela los describió.");

  // Andas hacia los totoros
  cSatsuki.Walk(534, 352, eBlock, eWalkableAreas);
  
  // Los totoros se asustan
  ctotoroAzul.Walk(688, 348, eNoBlock, eAnywhere);
  ctotoroBlanco.Walk(654, 364, eBlock, eAnywhere);
  Wait(75);
  
  imgDialogo.BackgroundGraphic = 150;
  mostrarDialogo("Vaya... Se han asustado");
  
  imgDialogo.BackgroundGraphic = 149;
  mostrarDialogo("¡Mei, cariño ven ya! ¡La comida se va a enfriar!");
  
  imgDialogo.BackgroundGraphic = 150;
  mostrarDialogo("¡Perdon! ¡Ya voy!");
}

//Si interactuas con los totoros pasa esto
function ctotoroAzul_Interact(Character *theCharacter, CursorMode mode)
{
  
  imgDialogo.BackgroundGraphic = 150;
  mostrarDialogo("Vaya… que bonitos y pequeñitos son. Se ven tal como la abuela los describió.");

  // Andas hacia los totoros
  cSatsuki.Walk(534, 352, eBlock, eWalkableAreas);
  
  // Los totoros se asustan
  ctotoroAzul.Walk(688, 348, eNoBlock, eAnywhere);
  ctotoroBlanco.Walk(654, 364, eBlock, eAnywhere);
  Wait(75);
  
  imgDialogo.BackgroundGraphic = 150;
  mostrarDialogo("Vaya... Se han asustado...");
  
  imgDialogo.BackgroundGraphic = 149;
  mostrarDialogo("¡Mei, cariño ven ya! ¡La comida se va a enfriar!");
  
  imgDialogo.BackgroundGraphic = 150;
  mostrarDialogo("¡Perdon! ¡Ya voy!");
  
}

function cMei_Look(Character *theCharacter, CursorMode mode)
{
  if(ultimaRoom == 2){
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("¿Qué es eso que tienes, Mei?");
  }
}

function cNanny_Talk(Character *theCharacter, CursorMode mode)
{
  imgDialogo.BackgroundGraphic = 149;
  mostrarDialogo("Deberiais coger el paraguas del armario e ir a buscar a vuestro padre, se esta haciendo tarde...");
}

function iCuerda_UseInv(InventoryItem *theItem, CursorMode mode)
{
  if(cSatsuki.ActiveInventory == iHebras){
    
    cSatsuki.LoseInventory(iCuerda);
    cSatsuki.LoseInventory(iHebras);
    cSatsuki.AddInventory(iHebraCuerda);
    
    // Esta línea es porque el juego se buggea y elimina los dos items,  pasa el tercer item y es como que se queda en tercera posición
    cSatsuki.LoseInventory(iPalo);
    cSatsuki.AddInventory(iPalo);
     
  }else{

    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("No encaja, tiene que haber otra forma");
  }
}

function iHebras_UseInv(InventoryItem *theItem, CursorMode mode)
{
  if(cSatsuki.ActiveInventory == iCuerda){
    
    cSatsuki.LoseInventory(iCuerda);
    cSatsuki.LoseInventory(iHebras);
    cSatsuki.AddInventory(iHebraCuerda);
    
    // Esta línea es porque el juego se buggea y elimina los dos items,  pasa el tercer item y es como que se queda en tercera posición
    cSatsuki.LoseInventory(iPalo);
    cSatsuki.AddInventory(iPalo);
       
  }else{

    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("No encaja, tiene que haber otra forma");
  }
}

function iPalo_UseInv(InventoryItem *theItem, CursorMode mode)
{
  if(cSatsuki.ActiveInventory == iCuerda){
    
    cSatsuki.LoseInventory(iCuerda);
    cSatsuki.LoseInventory(iPalo);
    cSatsuki.AddInventory(iPaloCuerda);
    
    // Esta línea es porque el juego se buggea y elimina los dos items combinados,  pasa el tercer item (si lo tiene) y es como que se queda en tercera posición
    cSatsuki.LoseInventory(iHebras);
    cSatsuki.AddInventory(iHebras);
  
  }else{
  // Meter un dialogo de que no encaja bien
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("No encaja, tiene que haber otra forma");
  }
}

function iHebraCuerda_UseInv(InventoryItem *theItem, CursorMode mode)
{
  if(cSatsuki.ActiveInventory == iHebraCuerda){
    
    cSatsuki.LoseInventory(iHebraCuerda);
    cSatsuki.LoseInventory(iPalo);
    cSatsuki.AddInventory(iEscoba);
    

  }else{

    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("No encaja, tiene que haber otra forma");
  }
}
function iGrupoBellotas_UseInv(InventoryItem *theItem, CursorMode mode)
{
  if(cSatsuki.ActiveInventory == iHojaPequena){
    
    cSatsuki.LoseInventory(iGrupoBellotas);
    cSatsuki.LoseInventory(iHojaPequena);
    cSatsuki.AddInventory(iBellotasEnvueltas);
  }else{
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("No encaja, tiene que haber otra forma");
  }
}

function iHojaPequena_UseInv(InventoryItem *theItem, CursorMode mode)
{
  if(cSatsuki.ActiveInventory == iHojaPequena){
    
    cSatsuki.LoseInventory(iGrupoBellotas);
    cSatsuki.LoseInventory(iHojaPequena);
    cSatsuki.AddInventory(iBellotasEnvueltas);
    
  }else{

    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("No encaja, tiene que haber otra forma");
  }
}

function iPaloHebra_UseInv(InventoryItem *theItem, CursorMode mode)
{
  if(cSatsuki.ActiveInventory == iPaloHebra){
    
    cSatsuki.LoseInventory(iPaloHebra);
    cSatsuki.LoseInventory(iCuerda);
    cSatsuki.AddInventory(iEscoba);
    
  }else{

    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("No encaja, tiene que haber otra forma");
  }
}

function iPaloCuerda_UseInv(InventoryItem *theItem, CursorMode mode)
{
  if(cSatsuki.ActiveInventory == iPaloCuerda){
    
    cSatsuki.LoseInventory(iPaloCuerda);
    cSatsuki.LoseInventory(iHebras);
    cSatsuki.AddInventory(iEscoba);
    
  }else{

    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("No encaja, tiene que haber otra forma");
  }
}

//Si usas un objeto sobre totoro
function cTotoro_UseInv(Character *theCharacter, CursorMode mode)
{
  //Si le das a totoro la hoja grande hace esto
  if(cSatsuki.ActiveInventory == iHojaArbol){
    cSatsuki.LoseInventory(iHojaArbol);
    ShakeScreen(1);
    
    imgDialogo.BackgroundGraphic = 265; // totoro
    mostrarDialogo("GRRRR....");
    
    FadeOut(2);
    cTotoro.ChangeView(14);
    FadeIn(2);
    
    Wait(50);
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Parece que está algo más contento, pero todavía falta algo.");
    mostrarDialogo("¿Se te ocurre qué más podemos darle a Totoro?");
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("Recuerdo que la abuela dijo que a los Totoros les gustaba robar las bellotas. A lo mejor podemos buscar algo por aquí para envolverlas e intentar dárselas.");
    
    puzleRoom3HojaCompletado = true; // Detector
  }
  
  //Si le das a totoro el conjunto de bellotas hace esto
  if(cSatsuki.ActiveInventory == iBellotasEnvueltas){
    
    cSatsuki.LoseInventory(iBellotasEnvueltas);
    puzleRoom3BellotasCompletado = true; //Detector
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Toma, Totoro, esto es para ti.");
    
    ShakeScreen(2);
    imgDialogo.BackgroundGraphic = 265; // totoro
    mostrarDialogo("Grrr....Grrr.....");
    Wait(50);
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("¡Ah! Ya nos tiene más confianza.");
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Eso parece, tal vez ahora sí acepte el paraguas.");
  }
  
  //Si le das el paraguas habiendole dado la hoja grande y el conjunto de bellotas,  hace esto
  if(cSatsuki.ActiveInventory == iParaguas && puzleRoom3BellotasCompletado && puzleRoom3HojaCompletado){
    
    cSatsuki.LoseInventory(iParaguas);
    puzleRoom3ParaguasCompletado = true; //Detector
    
    ShakeScreen(3);
    imgDialogo.BackgroundGraphic = 265; // totoro
    mostrarDialogo("Grrr....Grrr.....");
    
    FadeOut(2);
    cTotoro.ChangeView(15);
    
    FadeIn(2);
    Wait(50);
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Así no te mojarás más.");
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("Así no te mojarás más.");
    
    Wait(50);
    
    imgDialogo.BackgroundGraphic = 265;
    mostrarDialogo("¡Haaah!");
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Creo que le gusta el sonido de la lluvia sobre el paraguas.");
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("Eso parece.");
    
    //Totoro salta
    cTotoro.Move(270, 280, eBlock, eAnywhere);
    Wait(10);
    cTotoro.Move(270, 320, eBlock, eAnywhere);
    ShakeScreen(2);
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("¡Ay, vaya salto!");
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Eso digo yo…");
    
    imgDialogo.BackgroundGraphic = 265;
    mostrarDialogo("AAAAHHHHH.....");
    ShakeScreen(1);
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("???");
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("???");
    
    
    //Llega el gatobus y totoro se va
    cGatobus.Walk(300, 360, eBlock, eAnywhere);
    Wait(120);
    cTotoro.Scaling = 0;
    Wait(120);
    cGatobus.Walk(800, 380, eBlock, eAnywhere);
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Mei...¿Que... ha... sido...?");
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("Mira Satsuki parece que viene un Autobus");
    
    cBus2.Move(100, 360, eBlock, eAnywhere);
    cTatsuo.Move(100, 340, eBlock, eAnywhere);
    cBus2.Move(920, 360, eBlock, eAnywhere);
    
    Wait(60);
    cSatsuki.FaceDirection(eDirectionLeft);
    cMei.FaceDirection(eDirectionLeft);
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("¡Oh, ya está aquí papá!");
    
    imgDialogo.BackgroundGraphic = 270;
    mostrarDialogo("¿Qué hacéis aquí? Os estáis empapando.");
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Ya es tarde, nos habíamos preocupado y te hemos traído un paraguas.");
    
    imgDialogo.BackgroundGraphic = 150;
    mostrarDialogo("¡Papá, hemos visto a Totoro!");
    mostrarDialogo("¡Se han montado en un autobús con forma de gato y se han ido volando!");
    
    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("¡Sí!");
   
    imgDialogo.BackgroundGraphic = 270;
    mostrarDialogo("JAJAJA! ¡Muchas gracias niñas! Venga vamos a casa, Nanny estará preocupada…");
    
    cMei.Walk(-100, 360, eNoBlock, eAnywhere);
    cTatsuo.Walk(-100, 360, eNoBlock, eAnywhere);
    cSatsuki.Walk(-100, 360, eBlock, eAnywhere);
    
    FadeOut(1);
    Display("");
  }
  
  //Si no le has dado las bellotas o la hoja e intentas darle el paraguas hara esto
  if(cSatsuki.ActiveInventory == iParaguas && !puzleRoom3BellotasCompletado || !puzleRoom3HojaCompletado){

    imgDialogo.BackgroundGraphic = 148;
    mostrarDialogo("Jooo… todavía no quiere coger el paraguas. Hay que buscar algo más, Satsuki.");
  }
  
}
